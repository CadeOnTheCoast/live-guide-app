generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model Person {
  id                  String            @id @default(cuid())
  name                String
  email               String            @unique
  isActive            Boolean           @default(true)
  role                UserRole          @default(VIEWER)
  defaultDepartmentId String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  activitiesOwned     Activity[]        @relation("ActivityOwner")
  commsItemsOwned     CommsItem[]       @relation("CommsItemOwner")
  commsProfilesBackup CommsProfile[]    @relation("CommsProfileBackup")
  commsProfilesLead   CommsProfile[]    @relation("CommsProfileLead")
  keyResultsOwned     KeyResult[]       @relation("KeyResultOwner")
  defaultDepartment   Department?       @relation(fields: [defaultDepartmentId], references: [id])
  pressureAssetsOwned PressureAsset[]   @relation("PressureAssetOwner")
  primaryProjects     Project[]         @relation("ProjectPrimaryOwner")
  roleAssignments     RoleAssignment[]
  staffAllocations    StaffAllocation[]
  budgetComments      BudgetComment[]
}

model Department {
  id               String            @id @default(cuid())
  name             String
  code             String            @unique
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  isActive         Boolean           @default(true)
  sortOrder        Int               @default(0)
  activities       Activity[]
  keyResults       KeyResult[]
  milestones       Milestone[]
  people           Person[]
  staffAllocations StaffAllocation[]
}

model RoleAssignment {
  id        String   @id @default(cuid())
  projectId String
  personId  String
  role      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  person    Person   @relation(fields: [personId], references: [id])
  project   Project  @relation(fields: [projectId], references: [id])
}

model Project {
  id                     String            @id @default(cuid())
  name                   String
  slug                   String            @unique
  description            String?
  caseForChangeSummary   String?
  caseForChangePageUrl   String?
  status                 ProjectStatus     @default(ACTIVE)
  startDate              DateTime?
  endDate                DateTime?
  primaryOwnerId         String?
  asanaProjectGid        String?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  asanaTeamGid           String?
  asanaUrl               String?
  asanaWorkspaceGid      String?
  badges                 String[]          @default([])
  historyDebrief         String?
  projectFolderUrl       String?
  projectNotesUrl        String?
  teamsUrl               String?
  projectUpdateAgendaUrl String?
  isActive               Boolean           @default(true)
  activities             Activity[]
  budgetLines            BudgetLine[]
  callsToAction          CallToAction[]
  commsFaqs              CommsFaq[]
  commsFrames            CommsFrame[]
  commsItems             CommsItem[]
  commsProfile           CommsProfile?
  decisionMakers         DecisionMaker[]
  keyMessages            KeyMessage[]
  keyResults             KeyResult[]
  milestones             Milestone[]
  objectives             Objective[]
  pressureAssets         PressureAsset[]
  primaryOwner           Person?           @relation("ProjectPrimaryOwner", fields: [primaryOwnerId], references: [id])
  pushes                 Push[]
  relationships          Relationship[]
  roleAssignments        RoleAssignment[]
  staffAllocations       StaffAllocation[]
  stakeholders           Stakeholder[]
}

model Objective {
  id             String          @id @default(cuid())
  projectId      String
  title          String
  description    String?
  timeframeStart DateTime?
  timeframeEnd   DateTime?
  status         ObjectiveStatus @default(ON_TRACK)
  isCurrent      Boolean         @default(true)
  asanaTaskGid   String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  keyResults     KeyResult[]
  milestones     Milestone[]
  project        Project         @relation(fields: [projectId], references: [id])
  pushes         Push[]
}

model KeyResult {
  id           String          @id @default(cuid())
  projectId    String
  objectiveId  String
  code         String
  title        String
  description  String?
  targetValue  String?
  unit         String?
  currentValue String?
  status       KeyResultStatus @default(GREEN)
  dueDate      DateTime?
  isPrimary    Boolean         @default(false)
  ownerId      String?
  departmentId String?
  asanaTaskGid String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  activities   Activity[]
  department   Department?     @relation(fields: [departmentId], references: [id])
  objective    Objective       @relation(fields: [objectiveId], references: [id])
  owner        Person?         @relation("KeyResultOwner", fields: [ownerId], references: [id])
  project      Project         @relation(fields: [projectId], references: [id])

  @@unique([projectId, objectiveId, code])
}

model Push {
  id               String      @id @default(cuid())
  projectId        String
  sequenceIndex    Int
  name             String
  startDate        DateTime
  endDate          DateTime
  highLevelSummary String?
  objectiveId      String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  asanaProjectGid  String?
  activities       Activity[]
  commsItems       CommsItem[]
  milestones       Milestone[]
  objective        Objective?  @relation(fields: [objectiveId], references: [id])
  project          Project     @relation(fields: [projectId], references: [id])
}

model Activity {
  id                 String         @id @default(cuid())
  projectId          String
  pushId             String
  title              String
  description        String?
  startDate          DateTime?
  dueDate            DateTime?
  status             ActivityStatus @default(NOT_STARTED)
  ownerId            String?
  departmentId       String?
  relatedKrId        String?
  relatedMilestoneId String?
  asanaTaskGid       String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  department         Department?    @relation(fields: [departmentId], references: [id])
  owner              Person?        @relation("ActivityOwner", fields: [ownerId], references: [id])
  project            Project        @relation(fields: [projectId], references: [id])
  push               Push           @relation(fields: [pushId], references: [id])
  relatedKr          KeyResult?     @relation(fields: [relatedKrId], references: [id])
  relatedMilestone   Milestone?     @relation(fields: [relatedMilestoneId], references: [id])
}

model Milestone {
  id                 String            @id @default(cuid())
  projectId          String
  title              String
  description        String?
  date               DateTime
  isMajor            Boolean           @default(false)
  category           MilestoneCategory @default(OTHER)
  status             MilestoneStatus   @default(PLANNED)
  leadDepartmentId   String?
  relatedObjectiveId String?
  pushId             String?
  asanaTaskGid       String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  activities         Activity[]
  commsItems         CommsItem[]
  leadDepartment     Department?       @relation(fields: [leadDepartmentId], references: [id])
  project            Project           @relation(fields: [projectId], references: [id])
  push               Push?             @relation(fields: [pushId], references: [id])
  relatedObjective   Objective?        @relation(fields: [relatedObjectiveId], references: [id])
  pressureAssets     PressureAsset[]
}

model DecisionMaker {
  id                String          @id @default(cuid())
  projectId         String
  name              String
  title             String?
  organization      String?
  jurisdiction      String?
  priorityLevel     String?
  stance            String?
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  everyActionUrl    String?
  influencers       String?
  pressurePoints    String?
  reason            String?
  project           Project         @relation(fields: [projectId], references: [id])
  pressureAssets    PressureAsset[]
  relationshipsFrom Relationship[]  @relation("DecisionMakerFrom")
  relationshipsTo   Relationship[]  @relation("DecisionMakerTo")
}

model Stakeholder {
  id                String          @id @default(cuid())
  projectId         String
  name              String
  stakeholderType   StakeholderType
  organization      String?
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  audience          String?
  captains          String?
  everyActionUrl    String?
  plan              String?
  planToCounter     String?
  planToEducate     String?
  reason            String?
  influencers       String?
  relationshipsFrom Relationship[]  @relation("StakeholderFrom")
  relationshipsTo   Relationship[]  @relation("StakeholderTo")
  project           Project         @relation(fields: [projectId], references: [id])
}

model Relationship {
  id                String                @id @default(cuid())
  projectId         String
  fromDecisionId    String?
  fromStakeholderId String?
  toDecisionId      String?
  toStakeholderId   String?
  relationshipType  RelationshipType
  direction         RelationshipDirection
  strength          PowerRating
  notes             String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  fromDecision      DecisionMaker?        @relation("DecisionMakerFrom", fields: [fromDecisionId], references: [id])
  fromStakeholder   Stakeholder?          @relation("StakeholderFrom", fields: [fromStakeholderId], references: [id])
  project           Project               @relation(fields: [projectId], references: [id])
  toDecision        DecisionMaker?        @relation("DecisionMakerTo", fields: [toDecisionId], references: [id])
  toStakeholder     Stakeholder?          @relation("StakeholderTo", fields: [toStakeholderId], references: [id])
}

model PressureAsset {
  id                 String         @id @default(cuid())
  projectId          String
  decisionMakerId    String
  corner             PressureCorner
  title              String
  description        String?
  status             String?
  powerRating        PowerRating    @default(MEDIUM)
  weight             Float          @default(1.0)
  ownerId            String?
  relatedMilestoneId String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  decisionMaker      DecisionMaker  @relation(fields: [decisionMakerId], references: [id])
  owner              Person?        @relation("PressureAssetOwner", fields: [ownerId], references: [id])
  project            Project        @relation(fields: [projectId], references: [id])
  relatedMilestone   Milestone?     @relation(fields: [relatedMilestoneId], references: [id])
}

model CommsProfile {
  id                 String         @id @default(cuid())
  projectId          String         @unique
  commsLeadId        String?
  backupLeadId       String?
  approvalRequired   Boolean        @default(false)
  approverNotes      String?
  localNarrative     String?
  messagingWatchouts String?
  riskAndMinefields  String?
  generalNotes       String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  callsToAction      CallToAction[]
  commsFaqs          CommsFaq[]
  commsFrames        CommsFrame[]
  backupLead         Person?        @relation("CommsProfileBackup", fields: [backupLeadId], references: [id])
  commsLead          Person?        @relation("CommsProfileLead", fields: [commsLeadId], references: [id])
  project            Project        @relation(fields: [projectId], references: [id])
  keyMessages        KeyMessage[]
}

model KeyMessage {
  id             String       @id @default(cuid())
  projectId      String
  commsProfileId String
  priorityOrder  Int          @default(0)
  audience       AudienceType @default(EXTERNAL)
  text           String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  commsProfile   CommsProfile @relation(fields: [commsProfileId], references: [id])
  project        Project      @relation(fields: [projectId], references: [id])
}

model CallToAction {
  id             String             @id @default(cuid())
  projectId      String
  commsProfileId String
  description    String
  url            String?
  status         CallToActionStatus @default(ACTIVE)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  commsProfile   CommsProfile       @relation(fields: [commsProfileId], references: [id])
  project        Project            @relation(fields: [projectId], references: [id])
}

model CommsFrame {
  id             String       @id @default(cuid())
  projectId      String
  commsProfileId String
  title          String
  frame          String
  whyItWorks     String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  commsProfile   CommsProfile @relation(fields: [commsProfileId], references: [id])
  project        Project      @relation(fields: [projectId], references: [id])
}

model CommsFaq {
  id             String       @id @default(cuid())
  projectId      String
  commsProfileId String
  question       String
  answer         String
  priorityOrder  Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  commsProfile   CommsProfile @relation(fields: [commsProfileId], references: [id])
  project        Project      @relation(fields: [projectId], references: [id])
}

model CommsItem {
  id                 String          @id @default(cuid())
  projectId          String
  title              String
  type               CommsItemType
  plannedDate        DateTime?
  actualDate         DateTime?
  status             CommsItemStatus @default(IDEA)
  notes              String?
  linkUrl            String?
  ownerId            String?
  relatedMilestoneId String?
  relatedPushId      String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  owner              Person?         @relation("CommsItemOwner", fields: [ownerId], references: [id])
  project            Project         @relation(fields: [projectId], references: [id])
  relatedMilestone   Milestone?      @relation(fields: [relatedMilestoneId], references: [id])
  relatedPush        Push?           @relation(fields: [relatedPushId], references: [id])
}

model BudgetLine {
  id            String          @id @default(cuid())
  projectId     String
  category      String
  description   String
  amount        Decimal         @db.Decimal(10, 2)
  unitCost      Decimal?        @db.Decimal(10, 2)
  quantity      Float?
  currency      String          @default("USD")
  period        String
  fundingSource String?
  isActual      Boolean         @default(false)
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  project       Project         @relation(fields: [projectId], references: [id])
  comments      BudgetComment[]

  @@unique([projectId, category, description, period])
}

model BudgetComment {
  id           String     @id @default(cuid())
  budgetLineId String
  authorId     String
  text         String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  author       Person     @relation(fields: [authorId], references: [id])
  budgetLine   BudgetLine @relation(fields: [budgetLineId], references: [id])
}

model StaffAllocation {
  id           String      @id @default(cuid())
  projectId    String
  personId     String
  departmentId String?
  period       String
  hours        Float
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  department   Department? @relation(fields: [departmentId], references: [id])
  person       Person      @relation(fields: [personId], references: [id])
  project      Project     @relation(fields: [projectId], references: [id])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorEmail  String
  actorUserId String?
  action      String
  entityType  String
  entityId    String
  before      Json?
  after       Json?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)

  @@index([createdAt])
  @@index([actorEmail])
  @@index([entityType, entityId], map: "AuditLog_entity_idx")
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  PAUSED
  COMPLETED
}

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

enum ObjectiveStatus {
  ON_TRACK
  AT_RISK
  ACHIEVED
  NOT_PURSUED
}

enum KeyResultStatus {
  GREEN
  YELLOW
  RED
  ACHIEVED
}

enum MilestoneCategory {
  LEGISLATIVE
  LEGAL
  REGULATORY
  COMMUNITY
  INTERNAL
  OTHER
}

enum MilestoneStatus {
  PLANNED
  AT_RISK
  COMPLETED
  CANCELLED
  OFF_TRACK
}

enum ActivityStatus {
  NOT_STARTED
  IN_PROGRESS
  BLOCKED
  COMPLETED
}

enum StakeholderType {
  INFLUENCER
  OPPONENT
  ALLY
  MEDIA_OUTLET
  COMMUNITY_LEADER
  REGULATOR_STAFF
  DONOR
  OTHER
}

enum RelationshipType {
  FORMAL_AUTHORITY
  PERSONAL_CONNECTION
  DONOR_RELATIONSHIP
  STAFF_TO_BOSS
  MEDIA_RELATIONSHIP
  COMMUNITY_TRUST
  OTHER
}

enum RelationshipDirection {
  ONE_WAY
  MUTUAL
}

enum PowerRating {
  HIGH
  MEDIUM
  LOW
}

enum PressureCorner {
  INFLUENCE
  LEGAL
  GRASSROOTS
  MEDIA
}

enum CommsItemType {
  STORY
  OP_ED
  PRESS_RELEASE
  EMAIL_CAMPAIGN
  SOCIAL_CAMPAIGN
  EVENT
  PRESENTATION
  TOOLKIT
  OTHER
}

enum CommsItemStatus {
  IDEA
  PLANNED
  IN_PROGRESS
  PUBLISHED
  CANCELLED
}

enum AudienceType {
  EXTERNAL
  INTERNAL
  COMMUNITY
  POLICYMAKER
  MEDIA
  OTHER
}

enum CallToActionStatus {
  ACTIVE
  RETIRED
  PLANNED
}
